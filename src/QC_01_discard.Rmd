---
title: "Gene and Cell QC"
author: "NadineBestard"
date: "27/02/2021"
output: html_document
editor_options: 
  markdown: 
    wrap: 80
---


This is the same script as QC_01, however I will plot colouring by the chosen thresholds instead of the automatic ones 


# Set-up
```{r output-code, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r set-up, message=FALSE, warning=FALSE}
library(here) # for reproducible paths
library(SingleCellExperiment)
library(scater) # For qcs
library(org.Mm.eg.db) # To annotate the genenames
```

```{r load-sce}
sce <- readRDS(here( "processed", project, "sce_preliminary.RDS"))
project <- "fire-mice"
```

The object has `r dim(sce)[1]` genes and `r dim(sce)[2]` cells before filtering


```{r summary-discard}

# the manual thresholds I used
discard_mt <- sce$subsets_mt_percent > 15
discard_detected <- sce$detected < 900
discard_umi <- sce$total < 2000


# for some I kept the automated outlier detection
discard_umi_high <- isOutlier(sce$total, type = "higher")
discard_detected_high <-
  isOutlier(sce$detected, type = "higher")

# add label 'discard' to all cells to discard
sce$discard <- sce$outlier | sce$outlier_ratio | discard_mt | discard_umi | discard_detected

# Visualize the thresholds and the cells deleted by each parametre
summary_discard <- data.frame(
  umi_high = c(sum(discard_umi_high),
               attr(discard_umi_high, "thresholds")[2]),
  detected_high = c(sum(discard_detected_high),
                    attr(discard_detected_high, "thresholds")[2]),
  umi_low = c(sum(discard_umi),
              2000),
  detected_low = c(sum(discard_detected),
                   900),
  mt_pct = c(sum(discard_mt), 15),
  total = c(sum(sce$discard), NA)
)
row.names(summary_discard) <- c("Cells filtered", "Threshold")
write.csv(summary_discard, here("outs", project, "discard_summary.csv"))
```

### Violin plots

```{r}
plotColData(sce, x = "Sample", y = "sum", colour_by = "discard") +
  ggtitle("Total count") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
plotColData(sce, x = "Sample", y = "sum", colour_by = "discard") +
  scale_y_log10() + ggtitle("Total count log scale") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

```{r}
plotColData(sce, x = "Sample", y = "detected", colour_by = "discard") +
  scale_y_log10() + ggtitle("Detected Genes") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

```{r}
plotColData(sce, x = "Sample", y = "sum", colour_by = "chip") +
  scale_y_log10() + ggtitle("total count by batch") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```
 
 
```{r}
plotColData(sce, x = "Sample", y = "subsets_mt_percent", colour_by = "discard") +
  ggtitle("Mitocchondrial percentatge") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

### Histograms

In the x axis we can see the total number of umi (library size) per cell, the
number of detected genes per cell and the mitochondrial percentage per cell;
with the number of cells for each measure in the y axis.

```{r}
hist(
  sce$total,
  breaks = 100
)
```

This object had already been filtrated with the cell-calling algorithm from
CellRanger, that is meant to remove empty droplets. Therefore it is expected to
see the total sum of umi skewed as in the plot above.

```{r}
hist(
  sce$detected,
  breaks = 100
)
```

The bimodality present in the number of counts was already visible in the violin plots.

```{r}
hist(
  sce$subsets_mt_percent,
  breaks = 100
)
```

There is a very heavy tail of cells with high mitochondrial genes.

### Scatter plots

```{r}
plotColData(sce, x = "sum", y = "subsets_mt_percent", colour_by = "discard")
plotColData(sce, x = "sum", y = "detected", colour_by = "discard")
plotColData(sce, x = "sum", y = "detected", colour_by = "Sample")
```

### PCA

Here we run a PCA using the information in the metadata instead of the gene
detected. It is useful to visualize the QC parametres.

```{r PCA}
if (!file.exists(here( "processed", project, "sce_preliminary.RDS"))) {
  sce <- runColDataPCA(sce, variables = c("sum", "detected", "subsets_mt_percent"))
}
plotReducedDim(sce, dimred = "PCA_coldata", colour_by = "Sample")
plotReducedDim(sce, dimred = "PCA_coldata", colour_by = "chip")
```

### Ratio between sum and gene counts

This measures the number of detected genes per cell divided by its library
size. This will be very useful to delete the cells that have low gene counts but
a relatively high umi count (visible in the scatter plots).

```{r ratio}
if (!file.exists(here( "processed", project, "sce_preliminary.RDS"))) {
  sce$ratio_detected_sum <- sce$detected / sce$sum
  sce$discard_ratio <- isdiscard(sce$ratio_detected_sum, type = "both")
}

summary(sce$ratio_detected_sum)
plotColData(sce, x = "sum", y = "detected", colour_by = "ratio_detected_sum")
# Plot an histogram with the ratio between umi and gene counts
hist(
  sce$ratio_detected_sum,
  breaks = 100
)
```

The isdiscard function can but used to find the discards of any distribution, as
far as it is roughly normal. Bellow we use it with the ratio between the number
of genes expressed and the number of umi. Again, only the first 3 chips are considered to calculate the cut-offs

```{r ratio-plots}
# Use the is discard function from scater to see the cutoffs suggestions
plotColData(sce, x = "sum", y = "detected", colour_by = "discard_ratio")
attr(sce$discard_ratio, "thresholds")
```

 This filters out `r sum((sce$discard_ratio))` cells.



## Session Info

<details>
  <summary>Click to expand </summary>
```{r}
sessionInfo()
```

</details>
